#!/bin/bash

set -e

root=$(dirname $(dirname $(realpath $0)))
cpuset=$root/bin/lmu-cpuset
rc=$HOME/.lmurc

PASUSPENDER_ACTIVE=${PASUSPENDER_ACTIVE:-no}

if [[ ! -f $rc ]]; then
    echo "Configuration does not exist: $rc"
    exit 1
fi

source $rc

PASUSPENDER=${PASUSPENDER:-yes}

if [[ ! -f $cpuset ]]; then
    echo "Does not exist: $cpuset"
    exit 1
fi

if [[ -z $TOOLS ]]; then
    echo "$rc: TOOLS is not defined"
    echo "Example:"
    echo "TOOLS=\"qjackctl:0 ardour5:1\""
    exit 1
fi

if [[ -z $CPUS ]]; then
    echo "$rc: CPUS is not defined"
    echo "CPUS=\"0-1 2-3 4-7\""
    exit 1
fi

shutdown() {
    $cpuset stop
}

if [[ $PASUSPENDER == "yes" && $PASUSPENDER_ACTIVE != "yes" ]]; then
    echo "Suspending PulseAudio"
    exec env PASUSPENDER_ACTIVE=yes pasuspender -- $0 "$@"
    exit 1
fi

$cpuset start $CPUS

for tool in $TOOLS; do
    command=${tool%:*}
    id=${tool##*:}

    # TODO: log to syslog?
    $command > /dev/null 2> /dev/null &
    pid=$!
    $cpuset rt $id $pid
done

echo "Waiting for child processes to stop..."
wait

shutdown
